angular.module("lazyImage",[]).service("srcSetService",["$window",function(a){"use strict";function b(a){this.src=a.src,this.w=a.w||1/0,this.h=a.h||1/0,this.x=a.x||1}var c=/^[0-9]+$/,d=function(a){for(var b=a.split(/\s/),d={},e=0,f=b.length;f>e;e++){var g=b[e];if(g.length>0){var h=g.slice(-1),i=g.substring(0,g.length-1),j=parseInt(i,10),k=parseFloat(i);i.match(c)&&"w"===h?d[h]=j:i.match(c)&&"h"===h?d[h]=j:isNaN(k)||"x"!==h?window.console&&window.console.error('Invalid srcset descriptor found in "'+g+'".'):d[h]=k}}return d},e=function(a,b){for(var c=a[0],d=0,e=a.length;e>d;d++){var f=a[d];b(f,c)&&(c=f)}return c},f=function(a,b){for(var c=a.length-1;c>=0;c--){var d=a[c];b(d)&&a.splice(c,1)}return a},g=function(b){if(b){var c=b.slice(0),d={w:a.innerWidth||document.documentElement.clientWidth,h:a.innerHeight||document.documentElement.clientHeight,x:a.devicePixelRatio},g=e(c,function(a,b){return a.w>b.w});f(c,function(){return function(a){return a.w<d.w}}(this)),0===c.length&&(c=[g]);var h=e(c,function(a,b){return a.h>b.h});f(c,function(){return function(a){return a.h<d.h}}(this)),0===c.length&&(c=[h]);var i=e(c,function(a,b){return a.x>b.x});f(c,function(){return function(a){return a.x<d.x}}(this)),0===c.length&&(c=[i]);var j=e(c,function(a,b){return a.w<b.w});f(c,function(a){return a.w>j.w});var k=e(c,function(a,b){return a.h<b.h});f(c,function(a){return a.h>k.h});var l=e(c,function(a,b){return a.x<b.x});return f(c,function(a){return a.x>l.x}),c[0]}},h=function(a){var c=[],e=a.src,f=a.srcset;if(f){var h=function(a){for(var b=0,d=c.length;d>b;b++){var e=c[b];if(e.x===a.x&&e.w===a.w&&e.h===a.h)return}c.push(a)},i=function(){for(var a,c,g=f,i=0,j=[];""!==g;){for(;" "===g.charAt(0);)g=g.slice(1);if(i=g.indexOf(" "),-1!==i){if(a=g.slice(0,i),""===a)break;g=g.slice(i+1),i=g.indexOf(","),-1===i?(c=g,g=""):(c=g.slice(0,i),g=g.slice(i+1)),j.push({url:a,descriptors:c})}else j.push({url:g,descriptors:""}),g=""}for(var k=0,l=j.length;l>k;k++){var m=j[k],n=d(m.descriptors);h(new b({src:m.url,x:n.x,w:n.w,h:n.h}))}e&&h(new b({src:e}))};i();var j=g(c),k={best:j,candidates:c};return c=null,k}};return{get:h,image:g}}]).directive("tifLazyImage",["$window","srcSetService",function(a,b){"use strict";var c=function(a){return b.get({srcset:a}).best.src};return{restrict:"A",link:function(b,d,e){a=angular.element(a);var f,g=!1,h=e.tifLazyImage,i=null,j=function(){var b,e,k,l;l=a[0].innerHeight+a[0].scrollY,b=d[0].getBoundingClientRect().top+d[0].offsetHeight,e=b-l,k=e<=a[0].innerHeight,k&&!g&&(g=!0,i=c(h),f=angular.element('<img alt="" class="ng-lazy-image" src="'+i+'" />'),d.append(f),a.off("scroll",j))},k=function(){if(g){var a=c(h);a!==i&&(i=a,f[0].src=a)}};a.on("scroll",j),a.on("resize",k);var l=function(){a.off("scroll",j),a.off("resize",k),f=null};return b.$on("$destroy",function(){return l()}),j()}}}]);